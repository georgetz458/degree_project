<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js "></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


<head>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="/css/Style.css" rel="stylesheet">
    <meta charset="UTF-8">
    <title>Weather Statistics</title>
</head>
<body  style="text-align: center" >
<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Weather Analysis</a>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="/weatherMap">Per Municipality</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/avgPerHour">Hourly</a>
                </li>
            </ul>
            <button class="btn btn-outline-light forGuest"  id="loginButton" style="display: none;">Login</button>
            <button class="btn btn-outline-light forAdmin"  id="logOutButton" style="display: none;">Logout</button>

        </div>
    </div>
</nav>
<H1>Weather Statistics</H1>
<br>
<br>
<h5>Temperature, min temperature and max temperature over time.</h5>
<br>
<canvas id="tempChart"></canvas>
<br>
<br>
<h5>Difference of actual temperature  from the phone's temperature estimation over time.</h5>
<br>
<canvas id="tempDiffChart" ></canvas>
<br>
<br>
<h5>Humidity percentage over time.</h5>
<br>
<canvas id="humidityChart" ></canvas>
<br>
<br>
<h5>Air pressure over time.</h5>
<br>
<canvas id="airPressureChart" ></canvas>
<br>
<br>
<h5>Wind speed over time.</h5>
<br>
<canvas id="windSpeedChart" ></canvas>
<br>
<br>
<h5>Occurrences of wind direction over time are depicted in the chart.</h5>
<h6>The height of each bar represents the frequency of occurrence, while the direction of the bar corresponds to the wind direction.</h6>
<br>
<canvas id="windDirectionChart" class="canvas-circle"></canvas>
<br>
<br>
<h5>Comparison of in-pocket vs out-of-pocket percentages for various temperature differences between actual temperature and phone's estimation</h5>
<br>
<canvas id="inOutPocketPerTempEstDiffChart" ></canvas>
<br>
<br>
<h5>Day duration over time</h5>
<br>
<canvas id="dayDurationChart" ></canvas>
<br>
<br>
<h5>Weather percentage</h5>
<canvas id="weatherGeneralOccurrencesChart" class="canvas-circle"></canvas>
<br>
<br>
<h5>Daily weather data</h5>
<br>
<table class="table table-hover" style="width: 70%; margin: 0 auto;">
    <thead>
    <tr>
        <th>Date</th>
        <th>Temperature</th>
        <th>Phone's Temperature Estimation</th>
        <th>Air Pressure</th>
        <th>Humidity Percentage</th>
        <th>Weather</th>
        <th>WindSpeed</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="row : ${weatherDataPerDayList}">
        <td class="align-middle" th:text="${row.getDate()}"></td>
        <td class="align-middle" th:text="${row.getTemperature()} + '°C'"/>
        <td class="align-middle" th:text="${row.getPhoneTemp()} + '°C'"/>
        <td class="align-middle" th:text="${row.getAirPressure()} + 'hPa'"/>
        <td class="align-middle" th:text="${row.getHumidityPercentage()} + '%'"/>
        <td>
            <img th:src="@{/icons/__${row.getWeatherDescription()}__.png}" />
        </td>
        <td class="align-middle" th:text="${row.getWindSpeed()} + 'm/s'"/>

    </tr>
    </tbody>
</table>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script type="module">
    import {} from '/js/MyFunctions.js'
    import {} from '/js/FirebaseFunctions.js'
</script>
    <script th:inline="javascript">
        function createLineChart(name, labels, datasets, max, title) {
            let options;
            if(max!==0){
                options = {
                    legend: {display: true},
                    plugins: {
                        title: {
                            text: title,
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            min:0,
                            max: max
                        },
                        x: {
                            type: 'time'
                        }
                    }

                };
            }else{
                options = {
                    legend: {display: true},
                    plugins: {
                        title: {
                            text: title,
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'time'

                        }
                    }
                };
            }
            new Chart(name,{
                type:"line",
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: options

            });

        }
        var weatherProcessedDataList = [[${weatherProcessedDataList}]];
        const tempList = weatherProcessedDataList.map(a => a.temperature);
        const timestampList =weatherProcessedDataList.map(a => a.timestamp);
        const tempDiffList = weatherProcessedDataList.map(a => Math.abs(a.temperature - a.phoneTemp));
        const tempMinList = weatherProcessedDataList.map(a => a.tempMin);
        const tempMaxList = weatherProcessedDataList.map(a => a.tempMax);
        const airPressureList = weatherProcessedDataList.map(a => a.airPressure);
        const humidityPercentageList = weatherProcessedDataList.map(a => a.humidityPercentage);
        const windSpeedList = weatherProcessedDataList.map(a => a.windSpeed);

        //temp
        const tempDatasets = [{
            label:'Temperature',
            fill: false,
            spanGaps: true,
            borderColor: "rgba(0,0,255,1)",
            data: tempList
        },
            {
                label:'Temperature Min',
                fill: false,
                spanGaps: true,
                borderColor: "rgba(128,255,0,1)",
                data: tempMinList
            },
            {
                label:'Temperature Max',
                fill: false,
                spanGaps: true,
                borderColor: "rgba(255,102,102,1)",
                data: tempMaxList
            }];


        createLineChart("tempChart", timestampList, tempDatasets, 0, 'Temperature Chart');

        const tempDiffListDatasets = [{
            label:'Temperature-Phone Tempersture',
            fill: false,
            borderColor: "rgba(153,76,0,1)",
            data: tempDiffList
        }];
        createLineChart("tempDiffChart", timestampList, tempDiffListDatasets, 0, "Differentiation of Temperature and Phone's Temperature Estimation Chart");

        //humidity percentage
        const humidityListDatasets = [{
            label:'Humidity',
            fill: false,
            spanGaps: true,
            borderColor: "rgba(255, 102, 178, 1)",
            data: humidityPercentageList
        }];
        createLineChart("humidityChart", timestampList, humidityListDatasets, 0, 'Humidity Chart');

        //air pressure
        const airPressureListDatasets = [{
            label:'Pressure',
            fill: false,
            spanGaps: true,
            borderColor: "rgba(153,51,255,1)",
            data: airPressureList
        }];
        createLineChart("airPressureChart", timestampList, airPressureListDatasets, 0, 'Air Pressure Chart');

        //wind speed
        const windSpeedListDatasets = [{
            label:'Wind Speed',
            fill: false,
            spanGaps: true,
            borderColor: "rgba(255,178,102,1)",
            data: windSpeedList
        }];
        createLineChart("windSpeedChart", timestampList, windSpeedListDatasets, 0, 'Wind Speed Chart');


        var windDirectionList = [[${windDirectionList}]];
        let windDirectionCountList = windDirectionList.map(a => a.count);


            new Chart("windDirectionChart", {
            type: "polarArea",
            data: {
                labels: Array.from(Array(360).keys()),
                datasets: [
                    {
                        label: "Wind Direction Occurrence",
                        borderColor: "rgba(0,0,255,1)",
                        backgroundColor: "rgba(0,0,255,0.5)",
                        data: windDirectionCountList,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        text : 'Wind Direction Occurrence Chart',
                        display: true
                    }
                }

            }
        });

        // Συσχέτιση  in/out of pocket με διαφορά temperature estimation - temperature
        var inOutPocketPerTempEstDiffList = [[${inOutPocketPerTempEstDiffList}]];
        let inOutPocketPerTempEstDiffTempRange = inOutPocketPerTempEstDiffList.map(a => a.temperatureRange);
        let inOutPocketPerTempEstDiffInPocket = inOutPocketPerTempEstDiffList.map(a => a.inPocket);
        let inOutPocketPerTempEstDiffOutOfPocket = inOutPocketPerTempEstDiffList.map(a => a.outOfPocket);


        new Chart("inOutPocketPerTempEstDiffChart", {
            type: "bar",
            data: {
                labels: inOutPocketPerTempEstDiffTempRange,
                datasets: [
                    {
                        label: "Percentage",
                        borderColor: "rgba(0, 255, 0, 1)",
                        backgroundColor: "rgba(0, 255, 0, 1)",
                        data: inOutPocketPerTempEstDiffInPocket,
                        type: 'line', // Add stack identifier for grouping
                        fill: false

                    },
                    {
                        label: "in Pocket",
                        backgroundColor: "rgba(255, 102, 102, 1)",
                        data: inOutPocketPerTempEstDiffInPocket

                    },
                    {
                        label: "Out Of Pocket",
                        backgroundColor: "rgba(102, 178, 255, 1)",
                        data: inOutPocketPerTempEstDiffOutOfPocket

                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        text: 'In and out of pocket per temperature chart',
                        display: true
                    }
                },
                scales: {
                    x: {
                        stacked: true // Stack bars on the x-axis
                    },
                    y: {
                        stacked: true // Stack bars on the y-axis
                    }
                }
            }
        });
        //dayDurations
        var dayDurations = [[${dayDurations}]];
        const sunrises = dayDurations.map(a => a.sunrise);
        const sunsets = dayDurations.map(a => a.sunset);
        const dates = dayDurations.map(a=> a.date);


        const dayDurationDatasets = [{
            label: "sunrise",
            data: sunrises,
            backgroundColor: "rgba(0, 204, 204,1)",
            borderColor: "rgba(0, 204, 204,1)",
            fill: false
        },{
            label: "sunset",
            data: sunsets,
            backgroundColor: "rgba(255, 128,1)",
            borderColor: "rgba(255, 128,1)",
            fill: false
        }];


        new Chart("dayDurationChart",{
            type:"line",
            data: {
                labels: dates,
                datasets: dayDurationDatasets
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItems) {

                                const date = new Date(tooltipItems.parsed.y * 1000);
                                return date.getHours() + ":" + date.getMinutes() ;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Day Duration Chart'
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            display: false
                        }
                    }
                }
            }

        });
        //weatherGeneralOccurrences
        var weatherGeneralOccurrences = [[${weatherGeneralOccurrences}]];
        const weatherGeneralOccurrencesPercentage = weatherGeneralOccurrences.map(a => a.percentage);
        const weatherGeneralValues = weatherGeneralOccurrences.map(a => a.weatherGeneral);
        const weatherGeneralOccurrencesDatasets = [{
            label: "Percentage",
            data: weatherGeneralOccurrencesPercentage
        }];
        new Chart("weatherGeneralOccurrencesChart", {
            type: "doughnut",
            data: {
                labels: weatherGeneralValues,
                datasets: weatherGeneralOccurrencesDatasets
            },
            options :{
                plugins: {
                    title: {
                        text: 'Weather Occurrence Percentage Chart',
                        display: true
                    }
                },
            }

        });


        const rows = document.querySelectorAll('tbody tr');
        rows.forEach((row, index) => {
            row.addEventListener('click', () => {

                window.location.href = `/avgPerHour?day=${index}`;
            });
        });

    </script>
</body>
</html>